<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapa — Rutas, Paraderos y Grafo Bogotá</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        html,body { height:100%; margin:0; }
        #map { width:100%; height:100vh; }

        .control-box {
            position: absolute;
            top: 60px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            font-family: Arial, sans-serif;
            width: 230px;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            font-family: Arial, sans-serif;
            font-size: 13px;
        }

        .legend .item { margin-bottom:6px; }
        .legend .swatch { display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:middle; }
    </style>
</head>
<body>

<div class="control-box" id="controls">
    <div style="margin-bottom:6px; font-weight:bold;">
        Buscar Ruta
    </div>

    <input id="inputRuta" 
           type="text" 
           placeholder="Ej: H15, 6_2, T_1943"
           style="width:210px;padding:6px;margin-bottom:6px;border:1px solid #ccc;border-radius:4px;">

    <button id="btnBuscar" 
            style="width:100%;padding:6px;border:none;background:#333;color:white;border-radius:4px;cursor:pointer;">
        Buscar
    </button>

    <hr style="margin:10px 0;">

    <label style="font-size:13px;">
        <input id="chkMostrarGrafo" type="checkbox">
        Mostrar aristas (grafo)
    </label>
</div>


<div id="map"></div>

<div class="legend">
    <div class="item"><span class="swatch" style="background: red"></span> TRONCAL</div>
    <div class="item"><span class="swatch" style="background: blue"></span> URBANO</div>
    <div class="item"><span class="swatch" style="background: green"></span> ALIMENTADOR</div>
    <div class="item"><span class="swatch" style="background: purple"></span> METRO</div>
    <div class="item"><span class="swatch" style="background: gray"></span> MIXTO / UNKNOWN</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

const map = L.map('map').setView([4.65, -74.1], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

function colorPorTipo(tipo) {
    if (!tipo) return 'gray';
    tipo = String(tipo).toUpperCase();
    if (tipo.includes('TRONCAL')) return 'red';
    if (tipo.includes('URBANO')) return 'blue';
    if (tipo.includes('ALIMENTADOR') || tipo.includes('ALIM')) return 'green';
    if (tipo.includes('METRO')) return 'purple';
    return 'gray';
}


const capaBusqueda = L.layerGroup().addTo(map);
const rutasLayers = {
    'TRONCAL': L.layerGroup(),
    'URBANO': L.layerGroup(),
    'ALIMENTADOR': L.layerGroup(),
    'METRO': L.layerGroup(),
    'MIXTO': L.layerGroup(),
    'UNKNOWN': L.layerGroup()
};

const paraderosLayers = {
    'TRONCAL': L.layerGroup(),
    'URBANO': L.layerGroup(),
    'ALIMENTADOR': L.layerGroup(),
    'MIXTO': L.layerGroup(),
    'UNKNOWN': L.layerGroup()
};

const grafoEdgesLayer = L.layerGroup();

const rutasDic = {};
const rutasById = {};
const paraderosById = {};

let rutasGeojsonRaw = null;
let paraderosGeojsonRaw = null;
let grafoRaw = null;


const overlays = {
    'Rutas - TRONCAL': rutasLayers['TRONCAL'],
    'Rutas - URBANO': rutasLayers['URBANO'],
    'Rutas - ALIMENTADOR': rutasLayers['ALIMENTADOR'],
    'Rutas - METRO': rutasLayers['METRO'],
    'Paraderos - TRONCAL': paraderosLayers['TRONCAL'],
    'Paraderos - URBANO': paraderosLayers['URBANO'],
    'Paraderos - ALIMENTADOR': paraderosLayers['ALIMENTADOR'],
    'Mostrar aristas (grafo)': grafoEdgesLayer
};
L.control.layers(null, overlays, { collapsed: false }).addTo(map);


fetch('estaciones.geojson')
.then(r => r.json())
.then(data => {
    paraderosGeojsonRaw = data;

    data.features.forEach(f => {
        const props = f.properties || {};
        const tipo = (props.tipo || 'UNKNOWN').toUpperCase();
        const coords = f.geometry.coordinates;
        const latlng = [coords[1], coords[0]];
        const color = colorPorTipo(tipo);

        const marker = L.circleMarker(latlng, {
            radius: 4,
            color: color,
            fillColor: color,
            fillOpacity: 0.9
        }).bindPopup(`<b>${props.stop_name || props.nombre}</b><br>Tipo: ${props.tipo}`);

        paraderosById[props.stop_id] = marker;
        (paraderosLayers[tipo] || paraderosLayers['UNKNOWN']).addLayer(marker);
    });

    paraderosLayers['TRONCAL'].addTo(map);
    paraderosLayers['URBANO'].addTo(map);
    paraderosLayers['ALIMENTADOR'].addTo(map);
});

fetch("rutas.geojson")
.then(r => r.json())
.then(data => {
    rutasGeojsonRaw = data;

    L.geoJSON(data, {
        style: feature => ({
            color: colorPorTipo(feature.properties.tipo),
            weight: 3
        }),

        onEachFeature: (feature, layer) => {
            const props = feature.properties;
            const tipo = (props.tipo || "UNKNOWN").toUpperCase();
            const shortName = (props.short_name || "").toUpperCase();
            const routeId = props.route_id;

            if (shortName) rutasDic[shortName] = layer;
            if (routeId) rutasById[routeId] = layer;

            layer.bindPopup(
                `<b>${props.short_name}</b><br>${props.long_name}<br>${props.tipo}`
            );

            const bucket = rutasLayers[tipo] || rutasLayers["UNKNOWN"];
            bucket.addLayer(layer);
        }
    });


    rutasLayers["TRONCAL"].addTo(map);
    rutasLayers["URBANO"].addTo(map);
    rutasLayers["ALIMENTADOR"].addTo(map);
});



function ocultarTodasLasRutas() {
    for (const k in rutasLayers) {
        if (map.hasLayer(rutasLayers[k])) {
            map.removeLayer(rutasLayers[k]);
        }
    }
}

function mostrarTodasLasRutas() {
    rutasLayers['TRONCAL'].addTo(map);
    rutasLayers['URBANO'].addTo(map);
    rutasLayers['ALIMENTADOR'].addTo(map);
    rutasLayers['METRO'].addTo(map);
    rutasLayers['MIXTO'].addTo(map);
}


function buscarRuta() {
    const raw = (document.getElementById('inputRuta').value || '').trim();
    if (!raw) return;
    const key = raw.toUpperCase();

    let layer = rutasDic[key] || rutasById[key];
    if (!layer) {
        alert("No se encontró la ruta: " + raw);
        return;
    }


    for (const k in rutasLayers) {
        map.removeLayer(rutasLayers[k]);
    }


    capaBusqueda.clearLayers();


    capaBusqueda.addLayer(layer);
    map.addLayer(capaBusqueda);


    try {
        map.fitBounds(layer.getBounds().pad(0.25));
    } catch(e){}


    layer.setStyle({ color: "yellow", weight: 6 });

    setTimeout(() => {
        const tipo = layer.feature.properties.tipo || "UNKNOWN";
        layer.setStyle({ color: colorPorTipo(tipo), weight: 3 });
    }, 3500);
}


document.getElementById('btnBuscar').addEventListener('click', buscarRuta);
document.getElementById('inputRuta').addEventListener('keypress', e => {
    if (e.key === 'Enter') buscarRuta();
});
</script>
</body>
</html>
