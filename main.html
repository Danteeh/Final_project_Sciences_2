<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Mapa — Construcción de Grafo Bogotá</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100vh; }

.control-box {
    position:absolute;
    top:20px;
    left:20px;
    z-index:1000;
    background:white;
    padding:10px;
    border-radius:6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.24);
    width:300px;
    font-family:Arial;
    font-size:13px;
}

#pesoBox { display:none; margin-top:8px; }
#selectedPair { font-size:12px; font-weight:bold; margin-bottom:6px; }
#outputJson { width:100%; height:160px; font-family:monospace; font-size:11px; }
</style>
</head>

<body>

<div class="control-box">
    <div style="font-weight:bold;margin-bottom:6px;">Construcción de grafo</div>

    <button id="resetGrafo" style="width:100%;padding:6px;background:#aa0000;color:white;border:none;border-radius:4px;cursor:pointer;">
        Reiniciar Grafo
    </button>

    <div id="pesoBox">
        <div id="selectedPair"></div>
        <input type="number" id="inputPeso" placeholder="Peso de arista" style="width:100%;padding:6px;border:1px solid #bbb;border-radius:4px;margin-bottom:6px;">
        <button id="guardarEdge" style="width:100%;padding:6px;background:#0055aa;color:white;border:none;border-radius:4px;cursor:pointer;">
            Guardar arista
        </button>
        <button id="cancelEdge" style="width:100%;padding:6px;margin-top:5px;background:#888;color:white;border:none;border-radius:4px;cursor:pointer;">
            Cancelar
        </button>
    </div>

    <hr style="margin:10px 0;">
    <div style="font-weight:bold;margin-bottom:4px;">Grafo JSON</div>
    <textarea id="outputJson" readonly></textarea>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// ======== CAPACIDADES POR TIPO ========
const CAPACIDAD_POR_TIPO = {
  TRONCAL: 200,
  URBANO: 80,
  ALIMENTADOR: 60,
  METRO: 500,
  MIXTO: 120,
  UNKNOWN: 50
};

// ======== MAPA ========
const map = L.map('map').setView([4.65, -74.1], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

const capaSubgrafo = L.layerGroup().addTo(map);
const capaEstaciones = L.layerGroup().addTo(map);

const grafo = { nodos:{}, aristas:{} };
let seleccion1 = null;
let seleccion2 = null;

/* ======== COLORES CORRECTOS POR TIPO ======== */
function colorPorTipo(tipo) {
    tipo = String(tipo || '').toUpperCase();
    if (tipo === 'TRONCAL') return 'red';
    if (tipo === 'URBANO') return 'blue';
    if (tipo === 'ALIMENTADOR') return 'green';
    if (tipo === 'METRO') return 'purple';
    return 'gray';
}

// ======= Actualizar JSON en panel =======
function actualizarJson() {
    document.getElementById("outputJson").value = JSON.stringify(grafo, null, 2);
}

// ======== Reiniciar grafo local (no el mapa) ========
document.getElementById("resetGrafo").addEventListener("click", () => {
    grafo.nodos = {};
    grafo.aristas = {};
    seleccion1 = null;
    seleccion2 = null;
    capaSubgrafo.clearLayers();
    actualizarJson();
});

// ======== Cargar estaciones y mostrarlas siempre ========
let estacionesByCoordClick = {}; // id-> {lat,lng,tipo}

fetch("estaciones.geojson")
.then(r => r.json())
.then(data => {
  data.features.forEach(f => {
    const p = f.properties;
    const [lng, lat] = f.geometry.coordinates;
    const tipo = String(p.tipo || "UNKNOWN").toUpperCase();

    const marker = L.circleMarker([lat, lng], {
        radius: 5,
        color: colorPorTipo(tipo),
        fillColor: colorPorTipo(tipo),
        fillOpacity: 0.95
    })
    .bindPopup(`<b>${p.stop_name}</b><br>Tipo: ${tipo}<br>Capacidad: ${CAPACIDAD_POR_TIPO[tipo] ?? CAPACIDAD_POR_TIPO.UNKNOWN}`);

    // Mostrar en mapa siempre
    marker.addTo(capaEstaciones);

    // Guardar para detección por click cercano
    estacionesByCoordClick[p.stop_id] = { lat, lng, tipo };
  });
});

// ======== Selección para formar múltiples aristas ========
map.on("click", (e) => {

    let mejorNodo = null;
    let mejorDist = Infinity;

    // buscar nodo más cercano del dataset visualizado
    for (const nid in estacionesByCoordClick) {
        const n = estacionesByCoordClick[nid];
        const dx = e.latlng.lat - n.lat;
        const dy = e.latlng.lng - n.lng;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < mejorDist && dist < 0.02) { // tolerancia pequeña para detectar el click
            mejorDist = dist;
            mejorNodo = nid;
        }
    }

    if (!mejorNodo) return;

    const nSel = estacionesByCoordClick[mejorNodo];
    const tipoSel = nSel.tipo;
    const capSel = CAPACIDAD_POR_TIPO[tipoSel] ?? CAPACIDAD_POR_TIPO.UNKNOWN;

    // ===== Agregar nodo al grafo si no estaba =====
    if (!grafo.nodos[mejorNodo]) {
        grafo.nodos[mejorNodo] = { lat: nSel.lat, lng: nSel.lng, tipo: tipoSel, capacidad: capSel };
        grafo.aristas[mejorNodo] = [];
    }

    // Dibujar el nodo seleccionado sobre el mapa con borde negro para diferenciarlo
    L.circleMarker([nSel.lat, nSel.lng], {
        radius: 6,
        color: "black",
        fillColor: colorPorTipo(tipoSel),
        fillOpacity: 1
    }).addTo(capaSubgrafo);

    // ===== Si es el primer nodo de conexión =====
    if (!seleccion1) {
        seleccion1 = mejorNodo;
        document.getElementById("selectedPair").innerText = `Nodo seleccionado: ${seleccion1}\nAhora clickeá otro nodo para conectar`;
        return;
    }

    // ===== Si es el segundo nodo para crear arista =====
    if (!seleccion2 && mejorNodo !== seleccion1) {
        seleccion2 = mejorNodo;
        document.getElementById("selectedPair").innerText = `Arista: ${seleccion1} → ${seleccion2}`;
        document.getElementById("pesoBox").setAttribute("desde", seleccion1);
        document.getElementById("pesoBox").setAttribute("hasta", seleccion2);
        document.getElementById("pesoBox").style.display = "block";
    }

    actualizarJson();
});

// ===== Guardar arista sin sobrescribir otras =====
document.getElementById("guardarEdge").addEventListener("click", () => {
    const box = document.getElementById("pesoBox");
    const from = box.getAttribute("desde");
    const to = box.getAttribute("hasta");
    const pesoVal = Number(document.getElementById("inputPeso").value.trim());

    if (!pesoVal || pesoVal <= 0) {
        alert("Debe ser un peso positivo");
        return;
    }

    const tipoDest = grafo.nodos[to].tipo.toUpperCase();
    const capDest = CAPACIDAD_POR_TIPO[tipoDest] ?? CAPACIDAD_POR_TIPO.UNKNOWN;
    const pesoReal = Math.min(pesoVal, capDest);

    // No borramos otras aristas, agregamos una nueva
    grafo.aristas[from].push({
        to,
        peso: pesoReal,
        coordinates: [
          [ grafo.nodos[from].lng, grafo.nodos[from].lat ],
          [ grafo.nodos[to].lng, grafo.nodos[to].lat ]
        ]
    });

    // Dibujar arista en el mapa
    L.polyline(
        [
          [grafo.nodos[from].lat, grafo.nodos[from].lng],
          [grafo.nodos[to].lat, grafo.nodos[to].lng]
        ],
        { weight: 3, opacity: 0.8 }
    ).addTo(capaSubgrafo);

    // reset selección para permitir muchas conexiones desde A
    seleccion1 = null;
    seleccion2 = null;
    document.getElementById("inputPeso").value = "";
    box.style.display = "none";

    actualizarJson();
});

document.getElementById("cancelEdge").addEventListener("click", () => {
    seleccion1 = null;
    seleccion2 = null;
    document.getElementById("pesoBox").style.display = "none";
});

</script>

</body>
</html>
